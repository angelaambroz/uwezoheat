
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>Preschool enrolment, Kenya, 2013</title>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<link href='http://fonts.googleapis.com/css?family=Indie+Flower' rel='stylesheet' type='text/css'>
	<style type="text/css">

.buttons {
	color: #9799a7; /*not working, why?*/
	font: 400 16px 'Indie Flower', Arial;
	font-variant: small-caps;
}

.buttons:hover{
	cursor: pointer;
}

.boys:hover{
	color: white;
}

.tiny-label {
	font: 400 8px Arial;
	color: gray;
}


	</style>
</head>
<body>

	<script type="text/javascript">

		var w = 1000,
			h = 1000,
			userSubset, userAge;

		var svg = d3.select("body")
			.append("svg")
			.attr("width", w)
			.attr("height", h);

		var quantize = d3.scale.quantize()
			.domain([0, 1])
			.range(["rgb(247,251,255)", //monochromatic scale
					"rgb(222,235,247)", 
					"rgb(198,219,239)", 
					"rgb(158,202,225)",
					"rgb(107,174,214)",
					"rgb(66,146,198)",
					"rgb(33,113,181)",
					"rgb(8,81,156)",
					"rgb(8,48,107)"]); 

		var projection = d3.geo.mercator()
			.rotate([5,0,0])
			.translate([w/30-2500,h/2-100])
			.scale(4000);

		var path = d3.geo.path()
			.projection(projection);

		//Data
		d3.json("counties.json", function(json) {

			d3.csv("enrolment.csv", function(csv) {

	            //De-stringing
	            csv.forEach(function(d) { 
	            	for (var i = 3; i<=5; i++) {
	              		d["boys_"+i+"yrs"] = +d["boys_"+i+"yrs"];
	              		d["girls_"+i+"yrs"] = +d["girls_"+i+"yrs"];
	              		d.avg_all = +d.avg_all;
	             		}
	            });

	            //Can I collapse this all into a loop?
	            for (var i = 0; i < csv.length; i++) {
	            	var csvCounty = csv[i].county,
	            		avg_all = csv[i].avg_all,
	            		boys_3yrs = csv[i].boys_3yrs,
	            		boys_4yrs = csv[i].boys_4yrs,
	            		boys_5yrs = csv[i].boys_5yrs,
	            		girls_3yrs = csv[i].girls_3yrs,
	            		girls_4yrs = csv[i].girls_4yrs,
	            		girls_5yrs = csv[i].girls_5yrs;

	            //Merging csv with geojson data
	            	for (var j = 0; j < json.features.length; j++) {

	            		var jsonCounty = json.features[j].properties.COUNTY;

	            		if (csvCounty == jsonCounty) {

	            			json.features[j].properties.avg_all = avg_all;
	            			json.features[j].properties.boys_3yrs = boys_3yrs;
	            			json.features[j].properties.boys_4yrs = boys_4yrs;
	            			json.features[j].properties.boys_5yrs = boys_5yrs;
	            			json.features[j].properties.girls_3yrs = girls_3yrs;
	            			json.features[j].properties.girls_4yrs = girls_4yrs;
	            			json.features[j].properties.girls_5yrs = girls_5yrs;

	            			break;

	            		}
	            	}
	            }



					var counties = svg.selectAll("path")
					   .data(json.features);


					//Prepping for a fade-in
					counties.enter()
					   .append("path")
					   .attr("d", path)
					   .attr("stroke", "white")
					   .attr("fill", "white");


					//On-canvas buttons
					var buttons = svg.append("g")
						.attr("class", "buttons");

					//Boys
					var boys = buttons.append("g")
						.on("click", function() {
							userSubset = "boys";
							d3.select(".tiny-label")
								.text("Select age.");			
						});

					boys.append("rect")
						.attr("width", 50)
						.attr("height", 30)
						.attr("class", "button-rects")
						.attr("x", "50px")
						.attr("y", "100px")
						.attr("fill", "#E0E0FF");

					boys.append("text")
						.attr("x", "60px")
						.attr("y", "120px")
						.text("Boys");

					//Girls
					var girls = buttons.append("g")
						.on("click", function() {
							userSubset = "girls";
							d3.select(".tiny-label")
								.text("Select age.");
						});

					girls.append("rect")
						.attr("width", 50)
						.attr("height", 30)
						.attr("x", "100px")
						.attr("y", "100px")
						.attr("fill", "#FFF5FF");

					girls.append("text")
						.attr("x", "110px")
						.attr("y", "120px")
						.text("Girls");


					//3 year olds
					var threes = buttons.append("g")
						.on("click", function() {
							userAge = "3yrs";
							updateViz();
						});

					threes.append("rect")
						.attr("width", 40)
						.attr("height", 30)
						.attr("x", "40px")
						.attr("y", "130px")
						.attr("fill", "#DBFFDB");

					threes.append("text")
						.attr("x", "45px")
						.attr("y", "150px")
						.text("3yrs");

					//4 year olds
					var fours = buttons.append("g")
						.on("click", function() {
							userAge = "4yrs";
							updateViz();
						});
					
					fours.append("rect")
						.attr("width", 40)
						.attr("height", 30)
						.attr("x", "80px")
						.attr("y", "130px")
						.attr("fill", "#C2FFC2");

					fours.append("text")
						.attr("x", "85px")
						.attr("y", "150px")
						.text("4yrs");

					//5 year olds
					var fives = buttons.append("g")
						.on("click", function() {
							userAge = "5yrs";
							updateViz();
						});

					fives.append("rect")
						.attr("width", 40)
						.attr("height", 30)
						.attr("x", "120px")
						.attr("y", "130px")
						.attr("fill", "gray");

					fives.append("text")
						.attr("x", "125px")
						.attr("y", "150px")
						.text("5yrs");

					//Reset button
					var reset = buttons.append("g")
						.on("click", function() {
							d3.select(".tiny-label")
								.text("Reset to: All-Kenya average.");
							
							firstViz();
						});

					reset.append("rect")
						.attr("width", 50)
						.attr("height", 30)
						.attr("x", "125px")
						.attr("y", "200px")
						.attr("fill", "gray");

					reset.append("text")
						.attr("x", "125px")
						.attr("y", "220px")
						.text("Reset");


					//Tiny label
					buttons.append("text")
						.attr("class", "tiny-label")
						.attr("x", "40px")
						.attr("y", "175px")
						.text("Please make your selection.");

					//Moving the buttons around
					buttons.attr("transform", "translate(0,100) scale(1.3)");



					//The initial, aggregate-level map
					function firstViz() {

					//Resetting the user selections
					userSubset = undefined;
					userAge = undefined;

					counties.transition()
					 	.duration(750)
					 	.attr("fill", function(d) {
					   		if (d.properties.avg_all) {
								return quantize(d.properties.avg_all);
					   		} else {
					   			return "rgb(232,232,232)";
					   		}					   		
					   });

					//Static labels for printing
					/*
					    svg.selectAll("text")
						    .data(json.features)
						    .enter()
						    .append("svg:text")
						    .text(function(d){
						        return d.properties.COUNTY;
						    })
						    .attr("x", function(d){
						        return path.centroid(d)[0];
						    })
						    .attr("y", function(d){
						        return  path.centroid(d)[1];
						    })
						    .attr("font-family", "Arial")
						    .attr("text-anchor","middle")
						    .attr("font-size","4pt");
						*/

					}

					firstViz();


				//Update function to look at subsets
				function updateViz() {

					if (!userSubset) { alert("Please select boys or girls.")}

					var userSelection = userSubset + "_" + userAge;

					d3.select(".tiny-label")
						.text(function() {
							return "Selected: " + userSubset + ", " + userAge + ".";
						});

					counties.transition()
						.duration(750)
						.attr("fill", function(d) {
					   		if (d.properties[userSelection]) {
					   			return quantize(d.properties[userSelection]);
					   		} else {
					   			return "rgb(232,232,232)";
					   		}					   		
					   });
					}; //update function closer


				}); //csv closer
			}); //json closer
			
		</script>
	</body>
</html>